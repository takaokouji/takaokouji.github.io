---
layout: single
title:  "【不定期配信】最新のRuby & Railsへのバージョンアップ時の注意点 (~ 2021-10-17)"
categories: input
tags: ruby rails
toc: true
last_modified_at: 2021-10-18T18:18:08:29+0900
---
Ruby と Rails を安定して使い続けるために **最新の Ruby と Rails に対して行われた変更がバージョンアップするときに問題になるかどうか** という観点で情報をまとめています。

情報が多いので時間がない人は [Rubyの仕様変更の一覧](#rubyの仕様変更の一覧) と [Railsの仕様変更の一覧](#railsの仕様変更の一覧) を見てください。

Ruby の最新情報は [nagachikaさん (@nagachika) / Twitter](https://twitter.com/nagachika) が [ruby trunk changes](https://ruby-trunk-changes.hatenablog.com/) で公開してくださっています。
Rails の最新情報は [Pull requests · rails/rails](https://github.com/rails/rails/pulls?q=is%3Apr+is%3Aclosed) でマージされた PR を確認できるのと、[TechRacho｜BPS株式会社のRuby on Rails開発情報サイト](https://techracho.bpsinc.jp/) が [週刊Railsウォッチの記事一覧｜TechRacho by BPS株式会社](https://techracho.bpsinc.jp/tag/%e9%80%b1%e5%88%8arails%e3%82%a6%e3%82%a9%e3%83%83%e3%83%81) で公開してくださっています。

これらは大変有益な情報です。本当にありがたいことです。

{% include advertisements.html %}

## Ruby

### Rubyの仕様変更の一覧

#### ruby 3.0

- Ractor.make_shareable: バグ修正

#### ruby trunk

- SMTP.new と SMTP#start の引数
- GZipReader#gets

{% include advertisements.html %}

### ruby trunk

#### [ruby-trunk-changes 2021-10-15 - ruby trunk changes](https://ruby-trunk-changes.hatenablog.com/entry/ruby_trunk_changes_20211015)

以下のようにバージョンアップしている。影響はないです。

- pathname: 0.1.0 => 0.2.0
- open-uri: 0.1.0 => 0.2.0
- time: 0.1.0 => 0.2.0
- drb: 2.0.4 => 2.1.0
- date: 3.1.1 => 3.2.0

> [Update bundled_gems · ruby/ruby@fc9f923](https://github.com/ruby/ruby/commit/fc9f9231cf6ce911df37256faf22e6e8e23cb988)

【仕様変更】
net-smtp が 0.2.2 から 0.3.0 に変わっている。
SMTP.new と SMTP#start の引数が変わっている。tls を使っている人は要チェック。

> [[ruby/zlib] Fix a bug that GZipReader#gets may return incomplete line · ruby/ruby@027a337](https://github.com/ruby/ruby/commit/027a3379d67922738d503511c2123989229f8d9b)

【仕様変更】
GZipReader#getsのバグ修正だけど、以外とこういうので挙動が変わります。 `GZipReader#gets` を使っている人はコーナーケースの挙動を要チェック。

#### [ruby-trunk-changes 2021-10-16 - ruby trunk changes](https://ruby-trunk-changes.hatenablog.com/entry/ruby_trunk_changes_20211016)

OK
opensslの修正がいくつかあります。仕様変更はなさそうなのですが、どうやってこれが問題になると気がついたのか不思議。[@nagachika](https://twitter.com/nagachika) さんも「なるほど」と感心する修正だったようでCの拡張ライブラリを書いている人は見ておいたほうが良さそう。

#### [ruby-trunk-changes 2021-10-17 - ruby trunk changes](https://ruby-trunk-changes.hatenablog.com/entry/ruby_trunk_changes_20211017)

OK

### ruby 3.0

> [merge revision(s) 217df51f0e5d9824ed712a4d175f555d932e44d8: [Backport… · ruby/ruby@a2fe4b7](https://github.com/ruby/ruby/commit/a2fe4b75e4b236ad15778c59ace63006ace53889)

OK
[Bug #18232: Ractor.make_shareable is broken in code loaded with RubyVM::InstructionSequence.load_from_binary - Ruby master - Ruby Issue Tracking System](https://bugs.ruby-lang.org/issues/18232) の修正。内部情報が変わっただけ。

> [merge revision(s) 76228191474c76810043b294a74bbb2f1808b3d9: [Backport… · ruby/ruby@5427b08](https://github.com/ruby/ruby/commit/5427b08381fb0d644ec69d5aa94234f90a4fbed1)

【仕様変更】
Ractor.make_shareable の[バグ](https://bugs.ruby-lang.org/issues/18023) が修正されたようです。いちおう仕様変更扱いとしていますが困ることはないでしょう。

### ruby 2.7

変更なし。

## Rails

### Railsの仕様変更の一覧

変更なし。

{% include advertisements.html %}

### [Pull requests · rails/rails 2021-10-15](https://github.com/rails/rails/pulls?q=is%3Apr+is%3Aclosed+merged%3A2021-10-15)

> [Fix capybara driver name conflict by cjlarose · Pull Request #42511 · rails/rails](https://github.com/rails/rails/pull/42511)

OK
ActionDispatch::SystemTesting::Driver.newのキーワード引数にnameを追加して Capybara のドライバー名を設定できるようにしています。

> [Document alternative smtp_settings options by jacobherrington · Pull Request #43454 · rails/rails](https://github.com/rails/rails/pull/43454)

OK: doc

> [When generating form partials, use correct fields for date, time and datetime by lafeber · Pull Request #43458 · rails/rails](https://github.com/rails/rails/pull/43458)

OK
scaffoldで生成するformにおいて、date, time, datetime型のフィールド以下のように変更しています。Rails 独自の select フィールドではなくブラウザ標準のフィールドを使うようになります。

- time: `time_select` → `time_field`
- datetime, timestamp: `datetime_select` → `datetime_field`
- date: `date_select` → `date_field`

これはうれしい変更。これで「いまどきは date_field でしょ」と言えます。

> [No need to specify webdrivers version to support selenium-webdriver 4 by yahonda · Pull Request #43468 · rails/rails](https://github.com/rails/rails/pull/43468)

OK: Rails自体の開発で利用する webdrivers gemのバージョン指定をなくしただけ。

> [Fix system tests generated by scaffold by alexandreruban · Pull Request #43473 · rails/rails](https://github.com/rails/rails/pull/43473)

OK: generator
[Modernize scaffold generator by dhh · Pull Request #41210 · rails/rails](https://github.com/rails/rails/pull/41210) で scaffold が大きく変わったみたい。これもうれしい変更。開発初期しか scaffold は使わないので忘れがちだけど、scaffold は Railsの教科書のひとつ。常に新しいやり方が取り入れられているのはイイ！

> [Create directory when dumping schema cache by eileencodes · Pull Request #43474 · rails/rails](https://github.com/rails/rails/pull/43474)

OK
schema cache を dump するときに `FileUtils.mkdir_p(File.dirname(filename))` でキャッシュの保存先がなければ毎回作成するようにしています。バッチとかで定期的にキャッシュを消した時にディレクトリごと消すだけでよくなりますね。ナイス！

それにしても [eileencodes (Eileen M. Uchitelle)](https://github.com/eileencodes) さんのコミットが多い。どんな人なのだろうと思って調べてみると GitHub の人でかつ Rails のコアチームの人でした。
[Upgrading GitHub to Ruby 2.7 | The GitHub Blog](https://github.blog/2020-08-25-upgrading-github-to-ruby-2-7/) という記事も書かれていました。すごいな〜。

### [Pull requests · rails/rails 2021-10-16](https://github.com/rails/rails/pulls?q=is%3Apr+is%3Aclosed+merged%3A2021-10-16)

なし

### [Pull requests · rails/rails 2021-10-17](https://github.com/rails/rails/pulls?q=is%3Apr+is%3Aclosed+merged%3A2021-10-17)

> [Fix typo in upgrading_ruby_on_rails.md [ci-skip] by hachi8833 · Pull Request #43480 · rails/rails](https://github.com/rails/rails/pull/43480)

OK: doc。Markdownのタイプミスの修正。

### [Rails: Zeitwerkオートロードの「1ファイルにクラスを複数置けない」問題を回避する｜TechRacho by BPS株式会社](https://techracho.bpsinc.jp/hachi8833/2021_10_15/111156)

Rails 6.1以降にアップグレードするとオートロードで問題になるかもしれないという話。ワークアラウンドも丁寧に説明されている。とても参考になるので読んでおいたほうがいいですね。

## 今回のおまけ

[プロダクトマネジメント ―ビルドトラップを避け顧客に価値を届ける](https://amzn.to/3jc5oj1)を読み終えました。
<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=takaokouji-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=4873119251&linkId=9e14d3038b82ae3e3d7250a2de2da252"></iframe>

良書です。Rubyを使っているすべての開発者に読んでほしいと感じました。
あとでレビュー記事を書きます。
